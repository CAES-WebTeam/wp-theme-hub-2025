document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".wp-block-caes-hub-relevanssi-search").forEach((e=>{const t=e.querySelector(".relevanssi-search-form");if(!t)return;const a=""!==(e.dataset.resultsPageUrl||""),n="true"===e.dataset.showHeading,l=t.querySelector("#relevanssi-search-input"),r=t.querySelector("#relevanssi-sort-by-date"),s=t.querySelector("#relevanssi-post-type-filter"),o=t.querySelector("#relevanssi-language-filter"),i=e.querySelector(".relevanssi-ajax-search-results-container"),c=e.dataset.taxonomySlug||"category",d=e.dataset.allowedPostTypes?JSON.parse(e.dataset.allowedPostTypes):[],u="true"===e.dataset.showLanguageFilter,p=e.querySelector(".open-topics-modal"),f=e.querySelector("#topics-modal"),h=f?f.querySelector(".topics-modal-close"):null,v=f?f.querySelector(".apply-topics-filter"):null,y=e.querySelector(".open-authors-modal"),m=e.querySelector("#authors-modal"),g=m?m.querySelector(".authors-modal-close"):null,b=m?m.querySelector(".apply-authors-filter"):null;if(a){if(t.addEventListener("submit",(e=>{})),n){const e=l?l.value:"";E(e)}return}f&&f.querySelectorAll(".topics-modal-checkboxes label").forEach((e=>{e.classList.add("topic-checkbox-item")})),m&&m.querySelectorAll(".authors-modal-checkboxes label").forEach((e=>{e.classList.add("author-checkbox-item")}));const E=a=>{if(!n)return;let l=e.querySelector(".search-results-title");l||(l=document.createElement("h1"),l.className="search-results-title",t.parentNode.insertBefore(l,t));const r=e.getAttribute("data-custom-heading")||"Search";l.textContent=r,l.style.display="block"},S=a=>{let n=e.querySelector(".search-results-count");const l=e.querySelector(".search-results-heading");if(!n)if(n=document.createElement("div"),n.className="search-results-count",l)l.parentNode.insertBefore(n,l.nextSibling);else{const a=e.querySelector(".selected-topic-filters");a?a.parentNode.insertBefore(n,a.nextSibling):t.parentNode.insertBefore(n,t.nextSibling)}null!=a&&a>0?(n.textContent=1===a?"1 result found":`${a} results found`,n.style.display="block"):n.style.display="none"},k=(a=1)=>{if(!i)return;i.innerHTML='\n                <div class="plant-loading-container">\n                    <div class="plant-garden">\n                        <div class="plant">\n                            <div class="leaf leaf-left dark"></div>\n                            <div class="leaf leaf-right"></div>\n                            <div class="leaf leaf-left-2"></div>\n                            <div class="leaf leaf-right-2 darker"></div>\n                            <div class="leaf leaf-left-3 dark"></div>\n                            <div class="leaf leaf-right-3"></div>\n                            <div class="leaf leaf-left-4"></div>\n                            <div class="leaf leaf-right-4 dark"></div>\n                            <div class="leaf leaf-left-5 darker"></div>\n                            <div class="leaf leaf-right-5"></div>\n                        </div>\n        \n                        <div class="plant-2">\n                            <div class="leaf p2-leaf-left dark"></div>\n                            <div class="leaf p2-leaf-right"></div>\n                            <div class="leaf p2-leaf-left-2 darker"></div>\n                            <div class="leaf p2-leaf-right-2"></div>\n                            <div class="leaf p2-leaf-left-3 dark"></div>\n                            <div class="leaf p2-leaf-right-3"></div>\n                        </div>\n        \n                        <div class="plant-3">\n                            <div class="leaf p3-leaf-left"></div>\n                            <div class="leaf p3-leaf-right dark"></div>\n                            <div class="leaf p3-leaf-left-2 darker"></div>\n                            <div class="leaf p3-leaf-right-2"></div>\n                            <div class="leaf p3-leaf-left-3 dark"></div>\n                            <div class="leaf p3-leaf-right-3"></div>\n                            <div class="leaf p3-leaf-left-4"></div>\n                            <div class="leaf p3-leaf-right-4 darker"></div>\n                        </div>\n                    </div>\n                    <p class="loading-text">Loading results...</p>\n                </div>\n            ';const p=new FormData;p.append("action","caes_hub_search_results"),window.caesHubAjax&&window.caesHubAjax.nonce&&p.append("security",caesHubAjax.nonce);const h=l?l.value:"";if(p.append("s",h),p.append("paged",a),p.append("taxonomySlug",c),p.append("allowedPostTypes",JSON.stringify(d)),p.append("showDateSort",r?"true":"false"),p.append("showPostTypeFilter",s?"true":"false"),p.append("showTopicFilter",f?"true":"false"),p.append("showAuthorFilter",m?"true":"false"),p.append("showLanguageFilter",u?"true":"false"),r){const e=r.value;"post_date_desc"===e?(p.append("orderby","post_date"),p.append("order","desc")):"post_date_asc"===e?(p.append("orderby","post_date"),p.append("order","asc")):p.append("orderby","relevance")}s&&s.value&&p.append("post_type",s.value),o&&o.value&&p.append("language",o.value);let v=[];f&&(v=Array.from(f.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.value)).filter((e=>""!==e)),v.length>0&&v.forEach((e=>{p.append(`${c}[]`,e)})));let y=[];m&&(y=Array.from(m.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.value)).filter((e=>""!==e)),y.length>0&&y.forEach((e=>{p.append("author_slug[]",e)}))),n&&E(h);const g=Date.now();fetch(caesHubAjax.ajaxurl,{method:"POST",body:p}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.text()})).then((a=>{const n=Date.now()-g,l=Math.max(0,0-n);setTimeout((()=>{e.scrollIntoView(),i.innerHTML=a,(a=>{let n=e.querySelector(".search-results-heading");if(n&&n.remove(),a&&a.trim()){const n=document.createElement("h2");n.className="search-results-heading",n.textContent=`Results for: "${a.trim()}"`,n.style.display="block";const l=e.querySelector(".selected-topic-filters");l&&l.children.length>0?l.parentNode.insertBefore(n,l.nextSibling):t?t.parentNode.insertBefore(n,t.nextSibling):e.prepend(n)}})(h);let n=null;const l=i.querySelector("[data-results-count]");l&&(n=parseInt(l.getAttribute("data-results-count"),10));const r=i.querySelector('input[name="results_count"]');r&&null===n&&(n=parseInt(r.value,10));const s=i.querySelector(".wp-query-results-count");if(s&&null===n&&(n=parseInt(s.textContent,10)),null===n){const e=i.querySelector(".pagination-info, .wp-pagenavi");if(e){const t=e.textContent.match(/(\d+)\s+(?:results?|posts?|items?)/i);t&&(n=parseInt(t[1],10))}}if(null===n){const e=i.querySelectorAll(".search-result-item, article, .post, .result-item");e.length>0&&(n=e.length)}S(n),q()}),l)})).catch((e=>{console.error("Error fetching search results:",e);const t=Date.now()-g,a=Math.max(0,0-t);setTimeout((()=>{i.innerHTML='<p class="error-message">Error loading results. Please try again.</p>',S(null)}),a)})),x(p),w(v,y)},x=e=>{const t=new URLSearchParams;for(const[a,n]of e.entries())if(!["action","security","allowedPostTypes","showDateSort","showPostTypeFilter","showTopicFilter","showAuthorFilter","showLanguageFilter"].includes(a))if(a.endsWith("[]")){const e=a.slice(0,-2);t.append(e,n)}else t.set(a,n);const a=`${window.location.pathname}?${t.toString()}`;window.history.pushState({path:a},"",a)},w=(t,a)=>{const n=e.querySelector(".selected-topic-filters");if(!n)return;n.innerHTML="";const l=t&&t.length>0,r=a&&a.length>0;if(!l&&!r)return;const s=document.createElement("span");s.textContent="Filters applied:",s.className="filters-applied-label",n.appendChild(s);const o=document.createElement("div");o.className="filters-wrapper",l&&t.forEach((e=>{const t=f.querySelector(`input[value="${e}"]`),a=t?.parentElement?.textContent.trim()||e,n=document.createElement("div");n.className="topic-pill";const l=document.createElement("span");l.textContent=a;const r=document.createElement("button");r.setAttribute("type","button"),r.setAttribute("aria-label",`Remove filter ${a}`),r.innerHTML="&times;",r.addEventListener("click",(()=>{t&&(t.checked=!1),k()})),n.appendChild(l),n.appendChild(r),o.appendChild(n)})),r&&a.forEach((e=>{const t=m.querySelector(`input[value="${e}"]`),a=t?.parentElement?.textContent.trim()||e,n=document.createElement("div");n.className="author-pill";const l=document.createElement("span");l.textContent=a;const r=document.createElement("button");r.setAttribute("type","button"),r.setAttribute("aria-label",`Remove filter ${a}`),r.innerHTML="&times;",r.addEventListener("click",(()=>{t&&(t.checked=!1),k()})),n.appendChild(l),n.appendChild(r),o.appendChild(n)}));const i=document.createElement("button");i.textContent="Clear all",i.className="clear-all",i.setAttribute("type","button"),i.setAttribute("aria-label","Clear all selected filters"),i.addEventListener("click",(()=>{f&&f.querySelectorAll('input[type="checkbox"]:checked').forEach((e=>e.checked=!1)),m&&m.querySelectorAll('input[type="checkbox"]:checked').forEach((e=>e.checked=!1)),k()})),o.appendChild(i),n.appendChild(o)},q=()=>{i&&i.querySelectorAll(".page-numbers").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const a=new URL(e.href);let n=1;if(a.searchParams.has("paged"))n=parseInt(a.searchParams.get("paged"),10)||1;else{const e=a.pathname.split("/"),t=e.indexOf("page");if(t>-1&&t+1<e.length){const a=parseInt(e[t+1],10);!isNaN(a)&&a>0&&(n=a)}}k(n)}))}))},L=new URLSearchParams(window.location.search);if((L.has("s")||L.has("orderby")||L.has("post_type")||L.has("language")||L.getAll(c).length||m&&L.getAll("author_slug").length)&&k(),n){const e=l?l.value:"";E(e)}if(i&&i.children.length>0&&(()=>{if(!i)return;let e=null;const t=i.querySelector("[data-results-count]");if(t&&(e=parseInt(t.getAttribute("data-results-count"),10)),null===e){const t=i.querySelector('input[name="results_count"]');t&&(e=parseInt(t.value,10))}if(null===e){const t=i.querySelector(".wp-query-results-count");t&&(e=parseInt(t.textContent,10))}null!==e&&S(e)})(),t.addEventListener("submit",(e=>{e.preventDefault(),k()})),r&&r.addEventListener("change",(()=>k())),s&&s.addEventListener("change",(()=>k())),o&&o.addEventListener("change",(()=>k())),p&&f){let e;const t=()=>Array.from(f.querySelectorAll('a[href]:not([disabled]), button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])')).filter((e=>e.offsetWidth>0||e.offsetHeight>0)),a=e=>{const a=t();if(0===a.length)return;const n=a[0],r=a[a.length-1];"Tab"===e.key?e.shiftKey?document.activeElement===n&&(r.focus(),e.preventDefault()):document.activeElement===r&&(n.focus(),e.preventDefault()):"Escape"===e.key&&l()},n=()=>{e=document.activeElement,f.style.display="flex",p.setAttribute("aria-expanded","true"),f.removeAttribute("aria-hidden");const n=t();n.length>0&&n[0].focus(),document.addEventListener("keydown",a)},l=()=>{f.style.display="none",p.setAttribute("aria-expanded","false"),f.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",a),e&&e.focus()};p.addEventListener("click",n),h&&h.addEventListener("click",l),v?v.addEventListener("click",(()=>{k(),l()})):f.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.addEventListener("change",(()=>{k()}))})),window.addEventListener("click",(e=>{e.target===f&&l()}));const r=f.querySelector(".topics-modal-search-input");r&&r.addEventListener("input",(e=>{const t=e.target.value.toLowerCase();f.querySelectorAll(".topic-checkbox-item").forEach((e=>{const a=e.textContent.toLowerCase();e.style.display=a.includes(t)?"":"none"}))}))}if(y&&m){let e;const t=()=>Array.from(m.querySelectorAll('a[href]:not([disabled]), button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])')).filter((e=>e.offsetWidth>0||e.offsetHeight>0)),a=e=>{const a=t();if(0===a.length)return;const n=a[0],r=a[a.length-1];"Tab"===e.key?e.shiftKey?document.activeElement===n&&(r.focus(),e.preventDefault()):document.activeElement===r&&(n.focus(),e.preventDefault()):"Escape"===e.key&&l()},n=()=>{e=document.activeElement,m.style.display="flex",y.setAttribute("aria-expanded","true"),m.removeAttribute("aria-hidden");const n=t();n.length>0&&n[0].focus(),document.addEventListener("keydown",a)},l=()=>{m.style.display="none",y.setAttribute("aria-expanded","false"),m.setAttribute("aria-hidden","true"),document.removeEventListener("keydown",a),e&&e.focus()};y.addEventListener("click",n),g&&g.addEventListener("click",l),b?b.addEventListener("click",(()=>{k(),l()})):m.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.addEventListener("change",(()=>{k()}))})),window.addEventListener("click",(e=>{e.target===m&&l()}));const r=m.querySelector(".authors-modal-search-input");r&&r.addEventListener("input",(e=>{const t=e.target.value.toLowerCase();m.querySelectorAll(".author-checkbox-item").forEach((e=>{const a=e.textContent.toLowerCase();e.style.display=a.includes(t)?"":"none"}))}))}q()}))}));